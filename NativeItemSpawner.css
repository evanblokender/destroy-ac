using System;
using System.Collections.Generic;
using System.Runtime.InteropServices;
using UnityEngine;

public class NativeItemSpawner : MonoBehaviour
{
    [DllImport("ApplePlugin")]
    private static extern void RegisterSpawnCallback(SpawnDelegate cb);

    [DllImport("ApplePlugin")]
    private static extern void RequestSpawn(string itemName, int count);

    private delegate void SpawnDelegate(string itemName);

    public List<GameObject> spawnableItems;

    private Dictionary<string, GameObject> itemMap;
    private static NativeItemSpawner instance;

    void Awake()
    {
        instance = this;

        itemMap = new Dictionary<string, GameObject>();
        foreach (var item in spawnableItems)
            itemMap[item.name] = item;

        RegisterSpawnCallback(SpawnFromNative);
    }

    [AOT.MonoPInvokeCallback(typeof(SpawnDelegate))]
    private static void SpawnFromNative(string itemName)
    {
        instance.Spawn(itemName);
    }

    private void Spawn(string itemName)
    {
        if (!itemMap.ContainsKey(itemName)) return;

        Vector3 pos = Camera.main.transform.position;
        Instantiate(itemMap[itemName], pos, Quaternion.identity);
    }

    // Called by UI
    public void SpawnRequest(string itemName, int count)
    {
        RequestSpawn(itemName, count);
    }
}
